############################################################################################################
module Aethyr

  ############################################################################################################
  module Linux
  
    ############################################################################################################
    module Interface
    
      ##########################################################################################################
      class DiskPartitions
  
        ######################################################################################################
        #### class methods
        class << self
  
          ########################################################################################################
          def find(type = :all, options = {})
            if type.eql?(:first)
            else
              self.find_all
            end
          end

        ######################################################################################################
        protected
    
          ##########################################################################################################
          def find_all

            parts = {}
            
            rows = `ls -il /dev/sd* | egrep "sd[a-z][1-9]+"`.split("\n")
            rows.each do |r|
              r.gsub!(/^\s+/, '')
              attrs = r.split(/\s+/)
              parts[attrs[9]] = {
               :name         => attrs[9], 
               :last_updated => "#{attrs[7]} #{attrs[8]}", 
               :major_number => /(^\d+)/.match(attrs[5]).to_a.last, 
               :minor_number => attrs[6], 
               :links        => attrs[2], 
               :device_type  => /^(\w).*/.match(attrs[1]).to_a.last, 
               :owner        => attrs[3], 
               :group        => attrs[4],
               :i_node       => attrs[0],
              }
            end    
            
            rows = `cat /proc/partitions`.split("\n")
            rows.each do |r|
              r.gsub!(/^\s+/, '')
              next unless /^\d+/.match(r)
              attrs = r.split(/\s+/)
              dev_name = "/dev/#{attrs[3]}"
              parts[dev_name].update(:size => attrs[2], :size_units => 'KB') unless parts[dev_name].nil?
            end

            parts.values
            
          end
    
        ######################################################################################################
        end  
        
      ##########################################################################################################
      end
  
    ##########################################################################################################
    end

  ##########################################################################################################
  end
  
##########################################################################################################
end
